---
title: "Final Project" 
subtitle: "Stat 184"
author: "Tre Butler, Phil Saroka, Jessica Schick"
output: html_notebook
---

## Front Matter

```{r}
# clean up workspace environment
rm(list = ls())
# all packages used for the assignment
library(mosaicData)
library(mosaic)
library(DataComputing)
library(tidyverse)
library(forcats)
library(lubridate)
library(readxl)
library(ggplot2)
theme_set(theme_bw())
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(rworldmap)
library(rworldxtra)
library(leaflet)
library(data.table)
library(rgdal)
library(KernSmooth)
library(raster)
```

#Research Question:

How have outside factors like weather and time affected the distribution of crime rates in Boston?

#Data Sources:

##Where did you find them?
- Boston crime rates data - https://www.kaggle.com/ankkur13/boston-crime-data
- Boston weather data - https://www.ncdc.noaa.gov/

##Who collected/maintains them?
- Boston crime rates data - AnkurJain formed the dataset on Kaggle, but the information to create the dataset comes from the Boston Police Department
- Boston weather data - The NOAA gathers itâ€™s data from many sources including the World Meteorological Organization

##When & Why were they originally collected? 
Boston crime rates data - The dataset started in 2015 and was originally collected to find trends in crime statistics.
Boston weather data - The NOAA has kept weather statistics for many places for the past 30 years. They are collected for convenience to those who need to study trends in the weather.

##What does a case represent in each data source, and how many total cases are available?
Boston crime rates data - each case represent an Incident Number and there are a total of 260,760 cases available to use
Boston weather data - each case represent the Date of the Year and there are a total of 1,221 cases available to use

##What are some of the variables that you plan to use?
Boston crime rates data - Incident Number, Occurred on Date, Year, Month, Day of the Week, Hour, UCR Part, Street, Latitude, Longitude, Location, Offense Code
Boston weather data - Name, Latitude, Longitude, Date, Precipitation, Snow, Temperature Average
Plots, Summary Stats, and Observations

##TWO Data Sources (at least)
Primary data: Boston Crime Data 
Other data sources: Boston Weather Data

```{r table creation, message=FALSE, warning=FALSE, paged.print=FALSE}
#creating the datasets
boston_crime_statistics <- read_excel("crime.xlsx")
boston_crime_statistics<-boston_crime_statistics%>%
  rename("date"="OCCURRED_ON_DATE")%>%
  rename("lng"="Long")%>%
  rename("lat"="Lat")
weather_data <- read_csv("weather data.csv")
weather_data <- weather_data%>%
  dplyr::select(NAME,LATITUDE,LONGITUDE,DATE,PRCP, TAVG,SNOW)

```

## Joining datasets to create CrimeVsWeather Table

```{r left join}
CrimeVsWeather <-
  boston_crime_statistics %>%
  mutate("DATE" = ymd(as.Date(date))) %>%
  left_join(weather_data,"DATE")

```

## Using date verbs to create data for our graphic

```{r creation of crimes v weather table}
CrimeVsWeather <- 
  CrimeVsWeather %>%
  group_by(TAVG) %>%
  summarise(Total = n()) %>%
  arrange(desc(Total))
CrimeVsWeather

```

## Bar Graph Showing Avg Temperature Vs Crimes Committed

```{r creation of ggplot}
CrimeVsWeather %>% 
  ggplot(aes(x=TAVG,y=Total/100 ,fill=Total),color=TAVG) + #sets the plot
  ggtitle("Number of Crimes Committed vs \nAverage Day Temperature") +
  geom_bar(stat='identity',position='stack', width=.9) +
  labs(y="Number of Crimes Committed (per 100)", x = "Average Day Temperature") + 
  theme(legend.position = "none") #removes the key to make the graph look better

```
The bar graph is skewed left, with more crimes in the 65-80 degree range for temperature and the highest spike around 75 degrees. Based on the graph, we can see that there does appear to be a trend between average temperature and crimes committed. However, we do not believe that we can conclude causation because there may be many third party variables contributing to this apparent relationship.


```{r}
location_of_incident <- boston_crime_statistics%>%
  dplyr::select(INCIDENT_NUMBER,date,UCR_PART,STREET,lat,lng, Location)%>%
  arrange(date) #selects the specific vaiables that we are going to be using
```

```{r filtering unused data}
lang<-location_of_incident%>%
  dplyr::select(date,lng,lat)%>%
  filter(lat>40)%>%filter(lng<(-70)) #filters out any unusable data

```

## A Heat Map Showing Comparison Between Crime Rates And Temperature Patterns

```{r for loop}
for (n in 2015:2018){
  lower = as.POSIXct(as.Date(toString(paste(n,"-01-01 01:00:00",sep = "")))) #sets the lower and upper bounds for the range of the date
  upper = as.POSIXct(as.Date(toString(paste(n,"-12-31 23:59:00",sep = "")))) #that will be pushed into the table
  assign(paste("data_for_",n,sep = ""),lang%>% #assigns the data table name for each of the iterations of the for loop
    filter(between(lang$date,lower,upper)))
}

```

```{r function}
display_heatmap <- function(TABLE) {
  setattr(TABLE, "class", c("data.table")) #sets the table to be in the right class for use with the bkde2D function
  kde <- bkde2D(TABLE[ , list(lng, lat)],  
                bandwidth=c(.0045, .0068), gridsize = c(100,100))
  
  CrimeHeatMap <- raster(list(x=kde$x1 ,y=kde$x2 ,z = kde$fhat)) #creates a RasterLayer object for the pixels
  
  CrimeHeatMap@data@values[which(CrimeHeatMap@data@values < 1)] <- NA
  
  palRaster <- colorNumeric("Spectral", domain = CrimeHeatMap@data@values, na.color = "transparent") #sets the color palette 
  
  leaflet() %>% addTiles() %>%   #creates a leaflet object
    addRasterImage(CrimeHeatMap, 
                   colors = palRaster, 
                   opacity = .8) %>%
    addLegend(pal = palRaster, 
              values = CrimeHeatMap@data@values, 
              title = "Crime Heat Map")
}

```

```{r more functions}
average_lat_lng <- function(t) {
  newlist <- list("alat" = mean(t$lat, na.rm=T), "alng" = mean(t$lng, na.rm=T))
  return(newlist)
}
paste_faster <- function(t) {
  return <- paste("(",round(t$alat,5),",",round(t$alng,5),")",sep="")
}
difference <- function(t1,t2){
  return <- paste("(",round(t2$alat-t1$alat,8),",",round(t2$alng-t1$alng,8),")",sep="")
}

```

```{r info for multiple years}
avg_2015<-average_lat_lng(data_for_2015)
avg_2016<-average_lat_lng(data_for_2016)
avg_2017<-average_lat_lng(data_for_2017)
avg_2018<-average_lat_lng(data_for_2018)
cat(cat("The average latitude and longitude for 2015 is:",paste_faster(avg_2015),"\n"),
    cat("The average latitude and longitude for 2016 is:",paste_faster(avg_2016),"\n"),
    cat("The average latitude and longitude for 2017 is:",paste_faster(avg_2017),"\n"),
    cat("The average latitude and longitude for 2018 is:",paste_faster(avg_2018),"\n")
    )
cat(cat("Difference between 2015 and 2016 is",difference(avg_2015,avg_2016),"\n"),
    cat("Difference between 2016 and 2017 is",difference(avg_2016,avg_2017),"\n"),
    cat("Difference between 2017 and 2018 is",difference(avg_2017,avg_2018),"\n")
    )

```

```{r heatmap calls}
display_heatmap(data_for_2015)
display_heatmap(data_for_2016)
display_heatmap(data_for_2017)
display_heatmap(data_for_2018)

```

Based on the 4 heat maps, we can clearly see that the data do not change much over the course of these years. The crime data seem to be pretty centralized in Boston which is further backed up by the difference in means of the latitude and longitudes per each year.

