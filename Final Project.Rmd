---
title: "Final Project" 
subtitle: "Stat 184"
author: "Tre Butler, Phil Saroka, Jessica Schick"
output: html_notebook
---

## Front Matter

```{r}
# clean up workspace environment
rm(list = ls())
# all packages used for the assignment
library(mosaicData)
library(mosaic)
library(DataComputing)
library(tidyverse)
library(forcats)
library(lubridate)
library(readxl)
library(ggplot2)
theme_set(theme_bw())
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(rworldmap)
library(rworldxtra)
library(leaflet)
library(data.table)
library(rgdal)
library(KernSmooth)
library(raster)
```

#Research Question:

How have outside factors like weather and time affected the crime rates of Boston?

#Data Sources:

##Where did you find them? (I don’t think we should just say Google)
- Boston crime rates data - https://www.kaggle.com/ankkur13/boston-crime-data
- Boston weather data - https://www.ncdc.noaa.gov/

##Who collected/maintains them?
- Boston crime rates data - AnkurJain formed the dataset on Kaggle, but the information to create the dataset comes from the Boston Police Department
- Boston weather data - The NOAA gathers it’s data from many sources including the World Meteorological Organization

##When & Why were they originally collected? 

A) Boston crime rates data - The dataset started in 2015 and was originally collected to find trends in crime statistics.
B) Boston weather data - The NOAA has kept weather statistics for many places for the past 30 years. They are collected for convenience to those who need to study trends in the weather.

##What does a case represent in each data source, and how many total cases are available?
Boston crime rates data - each case represent an Incident Number and there are a total of 260,760 cases available to use
Boston weather data - each case represent the Date of the Year and there are a total of 1,221 cases available to use

##What are some of the variables that you plan to use?
Boston crime rates data - Incident Number, Occurred on Date, Year, Month, Day of the Week, Hour, UCR Part, Street, Latitude, Longitude, Location, Offense Code
Boston weather data - Name, Latitude, Longitude, Date, Precipitation, Snow, Temperature Average
Plots, Summary Stats, and Observations

##TWO Data Sources (at least)
Primary data:  Boston Crime Data 
Other data sources: Boston Weather Data

```{r message=FALSE, warning=FALSE}
#creating the datasets
boston_crime_statistics <- read_excel("crime.xlsx")
boston_crime_statistics<-boston_crime_statistics%>%
  rename("date"="OCCURRED_ON_DATE")%>%
  rename("lng"="Long")%>%
  rename("lat"="Lat")
weather_data <- read_csv("weather data.csv")
weather_data <- weather_data%>%
  dplyr::select(NAME,LATITUDE,LONGITUDE,DATE,PRCP, TAVG,SNOW)
```

## Joining datasets to create CrimeVsWeather Table
```{r}
CrimeVsWeather <-
  boston_crime_statistics %>%
  mutate("DATE" = ymd(as.Date(date))) %>%
  left_join(weather_data,"DATE")
```

## Using date verbs to create data for our graphic
```{r}
CrimeVsWeather <- 
  CrimeVsWeather %>%
  group_by(TAVG) %>%
  summarise(Total = n()) %>%
  arrange(desc(Total))
CrimeVsWeather
```

## Bar Graph Showing Avg Temperature Vs Crimes Committed
```{r}
CrimeVsWeather %>% 
  ggplot(aes(x=TAVG,y=Total/100 ,fill=Total),color=TAVG) +
  ggtitle("Number of Crimes Committed vs \nAverage Day Temperature") +
  geom_bar(stat='identity',position='stack', width=.9) +
  labs(y="Number of Crimes Committed (per 100)", x = "Average Day Temperature") + 
  theme(legend.position = "none")
```

```{r}
date_of_incident <- boston_crime_statistics%>%
  dplyr::select(INCIDENT_NUMBER,date,YEAR,MONTH,DAY_OF_WEEK,HOUR)%>%
  arrange(date)
location_of_incident <- boston_crime_statistics%>%
  dplyr::select(INCIDENT_NUMBER,date,UCR_PART,STREET,lat,lng, Location)%>%
  arrange(date)
```

```{r}
date_of_incident
```
```{r}
lang<-location_of_incident%>%
  dplyr::select(date,lng,lat)%>%
  filter(lat>40)%>%filter(lng<(-70))
```

```{r}
for (n in 2015:2018){
  lower = as.POSIXct(as.Date(toString(paste(n,"-01-01 01:00:00",sep = ""))))
  upper = as.POSIXct(as.Date(toString(paste(n,"-12-31 23:59:00",sep = ""))))
  assign(paste("data_for_",n,sep = ""),lang%>%
    filter(between(lang$date,lower,upper)))
}

```

```{r}
display_heatmap <- function(TABLE) {
  setattr(TABLE, "class", c("data.table"))
  kde <- bkde2D(TABLE[ , list(lng, lat)],
                bandwidth=c(.0045, .0068), gridsize = c(100,100))
  
  CrimeHeatMap <- raster(list(x=kde$x1 ,y=kde$x2 ,z = kde$fhat))
  
  CrimeHeatMap@data@values[which(CrimeHeatMap@data@values < 1)] <- NA
  
  palRaster <- colorNumeric("Spectral", domain = CrimeHeatMap@data@values, na.color = "transparent")
  
  leaflet() %>% addTiles() %>% 
    addRasterImage(CrimeHeatMap, 
                   colors = palRaster, 
                   opacity = .8) %>%
    addLegend(pal = palRaster, 
              values = CrimeHeatMap@data@values, 
              title = "Crime Heat Map")
}

```

```{r}
average_lat_lng <- function(t) {
  newlist <- list("alat" = mean(t$lat, na.rm=T), "alng" = mean(t$lng, na.rm=T))
  return(newlist)
}
paste_faster <- function(t) {
  return <- paste("(",round(t$alat,5),",",round(t$alng,5),")",sep="")
}
difference <- function(t1,t2){
  return <- paste("(",round(t2$alat-t1$alat,8),",",round(t2$alng-t1$alng,8),")",sep="")
}

```

```{r}
avg_2015<-average_lat_lng(data_for_2015)
avg_2016<-average_lat_lng(data_for_2016)
avg_2017<-average_lat_lng(data_for_2017)
avg_2018<-average_lat_lng(data_for_2018)
cat(cat("The average latitude and longitude for 2015 is:",paste_faster(avg_2015),"\n"),
    cat("The average latitude and longitude for 2016 is:",paste_faster(avg_2016),"\n"),
    cat("The average latitude and longitude for 2017 is:",paste_faster(avg_2017),"\n"),
    cat("The average latitude and longitude for 2018 is:",paste_faster(avg_2018),"\n")
    )
cat(cat("Difference between 2015 and 2016 is",difference(avg_2015,avg_2016),"\n"),
    cat("Difference between 2016 and 2017 is",difference(avg_2016,avg_2017),"\n"),
    cat("Difference between 2017 and 2018 is",difference(avg_2017,avg_2018),"\n")
    )


```
```{r}
display_heatmap(data_for_2015)
display_heatmap(data_for_2016)
display_heatmap(data_for_2017)
display_heatmap(data_for_2018)
```



